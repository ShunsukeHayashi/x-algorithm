# X「For You」アルゴリズム完全解説：公式実装から読み解く推薦システムの秘密

> **2026年1月22日公開**
> **カテゴリ**: レコメンデーションシステム, X(Twitter), アルゴリズム

---

Xの「おすすめ」フィードに出てくる投稿の選ばれ方。

「なんでこれが出てくるんだ？」と疑問に思ったことはありませんか？

実はXが**公式GitHubでアルゴリズムの実装を公開しています**。

本記事では、その公開実装（`xai-org/grok` ベース）を徹底分析し、For Youフィードの仕組みを完全解説します。

---

## はじめに：なぜアルゴリズムを公開するのか

「自社のアルゴリズムを公開するなんて自滅行為では？」

と思われるかもしれませんが、Xには明確な意図があります。

1. **オープンソースコミュニティへの貢献**
2. **技術的な透明性の確保**
3. **開発者からの信頼獲得**

そして何より、**「隠しても意味がない」**という自信の表れでもあります。

アルゴリズムの中身を知ることで、クリエイターとしても、ユーザーとしても、より賢く使えるようになります。

---

## For Youフィードの全体像

まずは全体像を把握しましょう。

```
For You Feedの構成

┌─────────────────────────────────────────┐
│           For You Feed Request          │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│            Home Mixer（指揮者）           │
│  ┌────────────────────────────────┐    │
│  │ Query Hydration               │    │
│  │ （ユーザー情報を取得）             │    │
│  └────────────────────────────────┘    │
│                    │                    │
│                    ▼                    │
│  ┌────────────────────────────────┐    │
│  │       Candidate Sources         │    │
│  │  ┌────────┐      ┌────────┐  │    │
│  │  │Thunder │      │Phoenix │  │    │
│  │  │(フォロー)│      │(MLおすすめ)│ │ │
│  │  └────────┘      └────────┘  │    │
│  └────────────────────────────────┘    │
│                    │                    │
│                    ▼                    │
│  ┌────────────────────────────────┐    │
│  │          Filtering              │    │
│  │  （重複・古い・NG除外）            │    │
│  └────────────────────────────────┘    │
│                    │                    │
│                    ▼                    │
│  ┌────────────────────────────────┐    │
│  │         Scoring（Grok Transformer） │    │
│  │  15種類のアクション確率を予測      │    │
│  └────────────────────────────────┘    │
│                    │                    │
│                    ▼                    │
│  ┌────────────────────────────────┐    │
│  │          Selection               │    │
│  │  スコア順にトップKを選択           │    │
│  └────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

**2つのソース**:

1. **In-Network（Thunder）**: フォローしているアカウントの投稿
2. **Out-of-Network（Phoenix）**: MLで発見したフォロー外の投稿

これらを**統合的にランクイング**しているのが特徴です。

---

## Thunder：フォロー投稿の高速配信

Thunderは「フォロー中の投稿」を配信するためのシステムです。

**特徴**:

```
Thunderの仕組み

・Kafkaで投稿イベントをリアルタイム収集
・ユーザーごとのインメモリストアを保持
・サブミリ秒で検索可能
```

**技術的ハイライト**:

- **Rust実装**: 高速処理を実現
- **インメモリDB**: 外部DBアクセスを回避
- **自動トリミング**: 一定期間経過で古い投稿を削除

「フォロワーが何万人いようが、サブミリ秒で検索できる」

この圧倒的な速度が、Thunderの強みです。

---

## Phoenix：MLベースのおすすめ発見

Phoenixは「フォローしていないけど、あなたが好きそう」な投稿を発見するシステムです。

### Two-Towerモデル

```
Two-Towerアーキテクチャ

User Tower                    Candidate Tower
    │                              │
    ▼                              ▼
[ユーザー特徴]      類似度計算      [投稿特徴]
・いいね履歴                    ──────→  [スコア]
・リプライ履歴
・フォロー中アカウント
```

- **User Tower**: ユーザーの特徴と行動履歴を埋め込み
- **Candidate Tower**: 全投稿を埋め込み
- **類似度計算**: 両者のドット積で類似度を算出

「あなたが似ているユーザーが見ている投稿」をおすすめする、というシンプルながら強力な仕組みです。

---

## Phoenix Scorer：Grok Transformerによる予測

Phoenixの心臓部である「Phoenix Scorer」。

ここでは**GrokベースのTransformerモデル**が、15種類のアクション確率を予測します。

```
予測する15種類のアクション

肯定的アクション:
├── P(favorite)      ・・・ いいね
├── P(reply)         ・・・ リプライ
├── P(repost)        ・・・ リポスト
├── P(quote)         ・・・ 引用リポスト
├── P(click)         ・・・ クリック
├── P(profile_click) ・・・ プロフィール閲覧
├── P(video_view)    ・・・ 動画視聴
├── P(photo_expand)   ・・・ 画像拡大
├── P(share)         ・・・ シェア
└── P(follow_author) ・・・ 著者をフォロー

否定的アクション:
├── P(not_interested)     ・・・ 興味なし
├── P(block_author)       ・・・ ブロック
├── P(mute_author)        ・・・ ミュート
└── P(report)             ・・・ 通報
```

これらを**重み付けして合計**し、最終的なスコアを算出します。

```
Final Score = Σ (weight_i × P(action_i))
```

ポジティブなアクションには正の重み、ネガティブなアクションには負の重みをつけることで、「ユーザーが興味を持ちそうな投稿」が上位に来るようになります。

---

## 候補Taboo「Candidate Isolation」: 候補同士が見えない設計

ここがこのシステムの一番面白いポイントです。

**Candidate Isolation（候補アイソレーション）**:

```
通常のTransformer Attention
┌─────────────────────────────────┐
│  投稿A  投稿B  投稿C  投稿D       │
│    └───────┘  │  │
│    「AがあるからB高スコア」         │
└─────────────────────────────────┘

Candidate Isolation
┌─────────────────────────────────┐
│  投稿A  投稿B  投稿C  投稿D       │
│         │         │  │
│    「お互いに見えない」          │
│    「独立したスコア」            │
└─────────────────────────────────┘
```

ランキング時、投稿同士が**互いに見えない**ようになっています。

これにより：

✅ **スコアの一貫性**: バッチに含まれる他投稿に影響されない
✅ **キャッシュ効率**: 投稿ごとにスコアを計算可能
✅ **並列処理の容易さ**: 独立したスコア計算が可能

というメリットが生まれます。

「投稿同士が見えない」という制約を入れることで、システム全体のシンプルさとパフォーマンスを両立させている賢い設計です。

---

## パイプライン処理の詳細

Home Mixer（オーケストレーションレイヤー）での処理フロー：

```
Pipeline Stages

1. Query Hydration
   └─ ユーザーのエンゲージメント履歴を取得
   └─ フォローリスト等のメタデータを取得

2. Candidate Sourcing
   ├─ Thunder: フォロー中の最新投稿
   └─ Phoenix Retrieval: MLで発見した投稿

3. Candidate Hydration
   ├─ 投稿本文・メディア
   ├─ 著者情報
   └─ 動画再生時間等

4. Pre-Scoring Filters
   ├─ 重複排除
   ├─ 古い投稿の除外
   ├─ 自分の投稿の除外
   ├─ ブロック/ミュート中除外
   └─ 既見/既配信除外

5. Scoring
   ├─ Phoenix Scorer: ML予測
   ├─ Weighted Scorer: 重み付け合計
   ├─ Author Diversity: 同著者連続抑制
   └─ OON Scorer: フォロー外調整

6. Selection
   └─ スコア順にトップKを選択

7. Post-Selection Filters
   └─ 最終チェック（削除・スパム等）
```

このパイプラインが**サブミリ秒単位で処理**されているんですね。

---

## 手作り特徴量を廃止した勇気

Xのエンジニアリングブログには、こうあります。

> We have eliminated every single hand-engineered feature and most heuristics from the system.

（手作りの特徴量をすべて排除した）

**何を排除したのか**:

- ❌ 手動で作った特徴量（ハンドエンジニアリング）
- ❌ ルルールベースのヒューリスティクス
- ✅ AI（Grok Transformer）に丸投げ

この**「AIに全てを任せる」**設計は、賛くか勇気がいると同時に、技術的にも洗練されています。

「人が考える特徴量なんて、AIが学習すれば勝てるでしょ」

この思想が、Xのアルゴリズムを支えているのです。

---

## 学び取りポイント：レコメンデーション開発者への示唆

この公開実装から、レコメンデーションシステム開発者が学べるポイントは多数です。

### 1. 複数のソースを統合する設計

「フォロー内のみ」または「フォロー外のみ」ではなく、**両方を統合してランキング**するアーキテクチャ。

### 2. スコアの一貫性を担保する設計

Candidate Isolationのように、システム全体のシンプルさを保ちながら、性能を出す工夫。

### 3. Rustによる高速処理

言語選びの重要性。Rustで書かれているのは、やはり理由があります。

### 4. 拡張性を考慮したアーキテクチャ

`CandidatePipeline`フレームワークのように、追加・変更を容易にする設計。

### 5. 公開によるエコシステム構築

アルゴリズムを公開することで、開発者からのフィードバックや信頼を獲得する戦略。

---

## おわりに：技術者にとっての恩恵

Xがアルゴリズムを公開したことで、我々技術者は得ることがたくさんあります。

- **学習材料**: 実際に動いているコードを読める
- **ベストプラクティス**: 大規模サービスの設計パターン
- **透明性**: どういうロジックで決まっているかが分かる

「アルゴリズムが公開されている」という事実は、クリエイターにとっても、ユーザーにとっても、プラスになるはずです。

---

**関連リンク**:

- GitHub: [xai-org/grok](https://github.com/xai-org/grok)
- X For You Feed Algorithm: [X's For You Feed Algorithm](https://github.com/xai-org/grok)

---

**作成者**: Shunsuke Hayashi
**Twitter**: [@The_AGI_WAY](https://x.com/The_AGI_WAY)
**note**: [note.ambitiousai.co.jp](https://note.ambitiousai.co.jp)

---

#X #レコメンデーション #アルゴリズム #推薦システム #エンジニアリング #OSS #Grok #MCP
